<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.png">
    <title>Authing SSO</title>
  </head>
  <body>
    <noscript>
      <strong>We're sorry but sso doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <!-- built files will be auto injected -->
  </body>
  <script>
    const getQueryString = function(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if ( r != null ){
        return unescape(r[2]);
      }else{
        return null;
      }
    };

    let appId = getQueryString('app_id') || getQueryString('client_id');
    let uuid = getQueryString('uuid') || null;
    let context = getQueryString('context') || null

    if (location.pathname === '/' 
      || location.pathname === '/login' 
      || location.pathname === '/login/'
    ) {
      if (!appId) {
        location.href = location.pathname + 'error?message=请提供 app_id 或 client_id&code=id404';
      }
    }

    const domain = "sso.authing.cn/login?app_id=YOUR_CLIENT_ID_";
    const guard = new AuthingGuard(appId, domain, {
      hideClose: true,
      SSOHost: location.origin,// 如果在 localhost:8080 跑，会出问题。线上 nginx 配置过二级域名转发，所以没事
      qrcodeScanning: {
        redirect: false,
      },
      host: {
        user: 'https://users.authing.cn/graphql',
        oauth: 'https://oauth.authing.cn/graphql',
      }
    });

    guard.on('authenticated', async (authing) => {
      if (guard.isLogged()) {
        // 已登录，直接跳至授权页
        if(context === 'SAMLIdP') {
          // 如果外界在和 Authing SAML IdP 通信，而 IdP 需要认证用户
          let SAMLRequest = getQueryString('SAMLRequest')
          guard.SAMLIdPLogin(SAMLRequest)
        } else if (context === 'OIDC') {
          guard.oidcLogin(uuid);
        } else {
          guard.sysAuthorize();
        }
      }
    });

    guard.on('login', (userInfo) => {
      if(context === 'SAMLIdP') {
        // 如果外界在和 Authing SAML IdP 通信，而 IdP 需要认证用户
        let SAMLRequest = getQueryString('SAMLRequest')
        guard.SAMLIdPLogin(SAMLRequest)
      } else if (context === 'OIDC') {
        guard.oidcLogin(uuid);
      } else {
        guard.sysAuthorize();
      }
    });

    guard.on('scanning', (userInfo) => {
      guard.sysAuthorize();
    });

    guard.on('loginError', (error) => {
      // Handle error 
      console.log('用户登录失败', error);
      // location.href = location.pathname + 'error?message=' + error.toString();
    });
  </script>
</html>
